shadow$provide.module$node_modules$konva$lib$shapes$Transformer=function(global,require,module,exports){function getCursor(anchorName,rad,isMirrored){if("rotater"===anchorName)return"crosshair";rad+=Util_1.Util._degToRad(ANGLES[anchorName]||0);isMirrored&&(rad*=-1);anchorName=(Util_1.Util._radToDeg(rad)%360+360)%360;if(Util_1.Util._inRange(anchorName,337.5,360)||Util_1.Util._inRange(anchorName,0,22.5))return"ns-resize";if(Util_1.Util._inRange(anchorName,22.5,67.5))return"nesw-resize";if(Util_1.Util._inRange(anchorName,
67.5,112.5))return"ew-resize";if(Util_1.Util._inRange(anchorName,112.5,157.5))return"nwse-resize";if(Util_1.Util._inRange(anchorName,157.5,202.5))return"ns-resize";if(Util_1.Util._inRange(anchorName,202.5,247.5))return"nesw-resize";if(Util_1.Util._inRange(anchorName,247.5,292.5))return"ew-resize";if(Util_1.Util._inRange(anchorName,292.5,337.5))return"nwse-resize";Util_1.Util.error("Transformer has unknown angle for cursor detection: "+anchorName);return"pointer"}var __extends=this&&this.__extends||
function(){var extendStatics=function(d$jscomp$0,b$jscomp$0){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return extendStatics(d$jscomp$0,b$jscomp$0)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Util_1=require("module$node_modules$konva$lib$Util");
global=require("module$node_modules$konva$lib$Factory");var Node_1=require("module$node_modules$konva$lib$Node"),Shape_1=require("module$node_modules$konva$lib$Shape"),Rect_1=require("module$node_modules$konva$lib$shapes$Rect"),Group_1=require("module$node_modules$konva$lib$Group"),Global_1=require("module$node_modules$konva$lib$Global");module=require("module$node_modules$konva$lib$Validators");require=require("module$node_modules$konva$lib$Global");var ATTR_CHANGE_LIST="resizeEnabledChange rotateAnchorOffsetChange rotateEnabledChange enabledAnchorsChange anchorSizeChange borderEnabledChange borderStrokeChange borderStrokeWidthChange borderDashChange anchorStrokeChange anchorStrokeWidthChange anchorFillChange anchorCornerRadiusChange ignoreStrokeChange".split(" ").map(function(e){return e+
".tr-konva"}).join(" "),TRANSFORM_CHANGE_STR="widthChange heightChange scaleXChange scaleYChange skewXChange skewYChange rotationChange offsetXChange offsetYChange transformsEnabledChange strokeWidthChange".split(" ").map(function(e){return e+".tr-konva"}).join(" "),ANGLES={"top-left":-45,"top-center":0,"top-right":45,"middle-right":-90,"middle-left":90,"bottom-left":-135,"bottom-center":180,"bottom-right":135},ANCHORS_NAMES="top-left top-center top-right middle-right middle-left bottom-left bottom-center bottom-right".split(" "),
Transformer=function(_super){function Transformer(config){config=_super.call(this,config)||this;config._transforming=!1;config._createElements();config._handleMouseMove=config._handleMouseMove.bind(config);config._handleMouseUp=config._handleMouseUp.bind(config);config.update=config.update.bind(config);config.on(ATTR_CHANGE_LIST,config.update);config.getNode()&&config.update();return config}__extends(Transformer,_super);Transformer.prototype.attachTo=function(node){this.setNode(node);return this};
Transformer.prototype.setNode=function(node){var _this=this;this._node&&this.detach();this._node=node;this._resetTransformCache();var additionalEvents=node._attrsAffectingSize.map(function(prop){return prop+"Change.tr-konva"}).join(" "),onChange=function(){_this._resetTransformCache();_this._transforming||_this.update()};node.on(additionalEvents,onChange);node.on(TRANSFORM_CHANGE_STR,onChange);node.on("xChange.tr-konva yChange.tr-konva",function(){return _this._resetTransformCache()});this.findOne(".top-left")&&
this.update();return this};Transformer.prototype.getNode=function(){return this._node};Transformer.prototype.detach=function(){this.getNode()&&(this.getNode().off(".tr-konva"),this._node=void 0);this._resetTransformCache()};Transformer.prototype._resetTransformCache=function(){this._clearCache("nodeRect");this._clearCache("transform");this._clearSelfAndDescendantCache("absoluteTransform")};Transformer.prototype._getNodeRect=function(){return this._getCache("nodeRect",this.__getNodeRect)};Transformer.prototype.__getNodeRect=
function(){var node=this.getNode();if(!node)return{x:-1E8,y:-1E8,width:0,height:0,rotation:0};node.parent&&this.parent&&node.parent!==this.parent&&Util_1.Util.warn("Transformer and attached node have different parents. Konva does not support such case right now. Please move Transformer to the parent of attaching node.");var rect=node.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()}),rotation=Global_1.Konva.getAngle(node.rotation()),dx=rect.x*node.scaleX()-node.offsetX()*
node.scaleX(),dy=rect.y*node.scaleY()-node.offsetY()*node.scaleY();return{x:node.x()+dx*Math.cos(rotation)+dy*Math.sin(-rotation),y:node.y()+dy*Math.cos(rotation)+dx*Math.sin(rotation),width:rect.width*node.scaleX(),height:rect.height*node.scaleY(),rotation:node.rotation()}};Transformer.prototype.getX=function(){return this._getNodeRect().x};Transformer.prototype.getY=function(){return this._getNodeRect().y};Transformer.prototype.getRotation=function(){return this._getNodeRect().rotation};Transformer.prototype.getWidth=
function(){return this._getNodeRect().width};Transformer.prototype.getHeight=function(){return this._getNodeRect().height};Transformer.prototype._createElements=function(){this._createBack();ANCHORS_NAMES.forEach(function(name){this._createAnchor(name)}.bind(this));this._createAnchor("rotater")};Transformer.prototype._createAnchor=function(name){var _this=this,anchor=new Rect_1.Rect({stroke:"rgb(0, 161, 255)",fill:"white",strokeWidth:1,name:name+" _anchor",dragDistance:0,draggable:!0}),self=this;
anchor.on("mousedown touchstart",function(e){self._handleMouseDown(e)});anchor.on("dragstart",function(e){e.cancelBubble=!0});anchor.on("dragmove",function(e){e.cancelBubble=!0});anchor.on("dragend",function(e){e.cancelBubble=!0});anchor.on("mouseenter",function(){var rad=Global_1.Konva.getAngle(_this.rotation()),scale=_this.getNode().getAbsoluteScale();rad=getCursor(name,rad,0>scale.y*scale.x);anchor.getStage().content.style.cursor=rad;_this._cursorChange=!0});anchor.on("mouseout",function(){anchor.getStage()&&
anchor.getParent()&&(anchor.getStage().content.style.cursor="",_this._cursorChange=!1)});this.add(anchor)};Transformer.prototype._createBack=function(){var back=new Shape_1.Shape({name:"back",width:0,height:0,listening:!1,sceneFunc:function(ctx){var tr=this.getParent(),padding=tr.padding();ctx.beginPath();ctx.rect(-padding,-padding,this.width()+2*padding,this.height()+2*padding);ctx.moveTo(this.width()/2,-padding);tr.rotateEnabled()&&ctx.lineTo(this.width()/2,-tr.rotateAnchorOffset()*Util_1.Util._sign(this.height()));
ctx.fillStrokeShape(this)}});this.add(back)};Transformer.prototype._handleMouseDown=function(e){this._movingAnchorName=e.target.name().split(" ")[0];var attrs=this._getNodeRect(),width=attrs.width;attrs=attrs.height;var hypotenuse=Math.sqrt(Math.pow(width,2)+Math.pow(attrs,2));this.sin=Math.abs(attrs/hypotenuse);this.cos=Math.abs(width/hypotenuse);window.addEventListener("mousemove",this._handleMouseMove);window.addEventListener("touchmove",this._handleMouseMove);window.addEventListener("mouseup",
this._handleMouseUp,!0);window.addEventListener("touchend",this._handleMouseUp,!0);this._transforming=!0;this._fire("transformstart",{evt:e});this.getNode()._fire("transformstart",{evt:e})};Transformer.prototype._handleMouseMove=function(e){var anchorNode=this.findOne("."+this._movingAnchorName);var newHypotenuse=anchorNode.getStage().getContent().getBoundingClientRect();anchorNode.setAbsolutePosition({x:(void 0!==e.clientX?e.clientX:e.touches[0].clientX)-newHypotenuse.left,y:(void 0!==e.clientX?
e.clientY:e.touches[0].clientY)-newHypotenuse.top});newHypotenuse=this.keepRatio()||e.shiftKey;if("top-left"===this._movingAnchorName){if(newHypotenuse){newHypotenuse=Math.sqrt(Math.pow(this.findOne(".bottom-right").x()-anchorNode.x(),2)+Math.pow(this.findOne(".bottom-right").y()-anchorNode.y(),2));var x=this.findOne(".top-left").x()>this.findOne(".bottom-right").x()?-1:1;var reverseY=this.findOne(".top-left").y()>this.findOne(".bottom-right").y()?-1:1;x*=newHypotenuse*this.cos;var y=newHypotenuse*
this.sin*reverseY;this.findOne(".top-left").x(this.findOne(".bottom-right").x()-x);this.findOne(".top-left").y(this.findOne(".bottom-right").y()-y)}}else if("top-center"===this._movingAnchorName)this.findOne(".top-left").y(anchorNode.y());else if("top-right"===this._movingAnchorName)newHypotenuse&&(newHypotenuse=Math.sqrt(Math.pow(this.findOne(".bottom-left").x()-anchorNode.x(),2)+Math.pow(this.findOne(".bottom-left").y()-anchorNode.y(),2)),x=this.findOne(".top-right").x()<this.findOne(".top-left").x()?
-1:1,reverseY=this.findOne(".top-right").y()>this.findOne(".bottom-left").y()?-1:1,x*=newHypotenuse*this.cos,y=newHypotenuse*this.sin*reverseY,this.findOne(".top-right").x(x),this.findOne(".top-right").y(this.findOne(".bottom-left").y()-y)),newHypotenuse=anchorNode.position(),this.findOne(".top-left").y(newHypotenuse.y),this.findOne(".bottom-right").x(newHypotenuse.x);else if("middle-left"===this._movingAnchorName)this.findOne(".top-left").x(anchorNode.x());else if("middle-right"===this._movingAnchorName)this.findOne(".bottom-right").x(anchorNode.x());
else if("bottom-left"===this._movingAnchorName)newHypotenuse&&(newHypotenuse=Math.sqrt(Math.pow(this.findOne(".top-right").x()-anchorNode.x(),2)+Math.pow(this.findOne(".top-right").y()-anchorNode.y(),2)),x=this.findOne(".top-right").x()<this.findOne(".bottom-left").x()?-1:1,reverseY=this.findOne(".bottom-right").y()<this.findOne(".top-left").y()?-1:1,x*=newHypotenuse*this.cos,y=newHypotenuse*this.sin*reverseY,this.findOne(".bottom-left").x(this.findOne(".top-right").x()-x),this.findOne(".bottom-left").y(y)),
newHypotenuse=anchorNode.position(),this.findOne(".top-left").x(newHypotenuse.x),this.findOne(".bottom-right").y(newHypotenuse.y);else if("bottom-center"===this._movingAnchorName)this.findOne(".bottom-right").y(anchorNode.y());else if("bottom-right"===this._movingAnchorName)newHypotenuse&&(newHypotenuse=Math.sqrt(Math.pow(this.findOne(".bottom-right").x(),2)+Math.pow(this.findOne(".bottom-right").y(),2)),x=this.findOne(".top-left").x()>this.findOne(".bottom-right").x()?-1:1,reverseY=this.findOne(".top-left").y()>
this.findOne(".bottom-right").y()?-1:1,x*=newHypotenuse*this.cos,y=newHypotenuse*this.sin*reverseY,this.findOne(".bottom-right").x(x),this.findOne(".bottom-right").y(y));else if("rotater"===this._movingAnchorName){newHypotenuse=this.padding();reverseY=this._getNodeRect();x=anchorNode.x()-reverseY.width/2;y=-anchorNode.y()+reverseY.height/2;anchorNode=Math.atan2(-y,x)+Math.PI/2;0>reverseY.height&&(anchorNode-=Math.PI);x=Global_1.Konva.getAngle(this.rotation());anchorNode=Util_1.Util._radToDeg(x)+Util_1.Util._radToDeg(anchorNode);
y=Global_1.Konva.getAngle(this.getNode().rotation());for(var newAlpha=Util_1.Util._degToRad(anchorNode),snaps=this.rotationSnaps(),i=0;i<snaps.length;i++){var angle=Global_1.Konva.getAngle(snaps[i]);.1>Math.abs(angle-Util_1.Util._degToRad(anchorNode))%(2*Math.PI)&&(anchorNode=Util_1.Util._radToDeg(angle),newAlpha=Util_1.Util._degToRad(anchorNode))}this._fitNodeInto({rotation:Global_1.Konva.angleDeg?anchorNode:Util_1.Util._degToRad(anchorNode),x:reverseY.x+(reverseY.width/2+newHypotenuse)*(Math.cos(y)-
Math.cos(newAlpha))+(reverseY.height/2+newHypotenuse)*(Math.sin(-y)-Math.sin(-newAlpha))-(newHypotenuse*Math.cos(x)+newHypotenuse*Math.sin(-x)),y:reverseY.y+(reverseY.height/2+newHypotenuse)*(Math.cos(y)-Math.cos(newAlpha))+(reverseY.width/2+newHypotenuse)*(Math.sin(y)-Math.sin(newAlpha))-(newHypotenuse*Math.cos(x)+newHypotenuse*Math.sin(x)),width:reverseY.width+2*newHypotenuse,height:reverseY.height+2*newHypotenuse},e)}else console.error(Error("Wrong position argument of selection resizer: "+this._movingAnchorName));
if("rotater"!==this._movingAnchorName){newHypotenuse=this.findOne(".top-left").getAbsolutePosition(this.getParent());if(this.centeredScaling()||e.altKey)newHypotenuse=this.findOne(".top-left"),reverseY=this.findOne(".bottom-right"),x=newHypotenuse.x(),anchorNode=newHypotenuse.y(),y=this.getWidth()-reverseY.x(),newAlpha=this.getHeight()-reverseY.y(),reverseY.move({x:-x,y:-anchorNode}),newHypotenuse.move({x:y,y:newAlpha}),newHypotenuse=newHypotenuse.getAbsolutePosition(this.getParent());x=newHypotenuse.x;
y=newHypotenuse.y;newHypotenuse=this.findOne(".bottom-right").x()-this.findOne(".top-left").x();reverseY=this.findOne(".bottom-right").y()-this.findOne(".top-left").y();this._fitNodeInto({x:x+this.offsetX(),y:y+this.offsetY(),width:newHypotenuse,height:reverseY},e)}};Transformer.prototype._handleMouseUp=function(e){this._removeEvents(e)};Transformer.prototype._removeEvents=function(e){if(this._transforming){this._transforming=!1;window.removeEventListener("mousemove",this._handleMouseMove);window.removeEventListener("touchmove",
this._handleMouseMove);window.removeEventListener("mouseup",this._handleMouseUp,!0);window.removeEventListener("touchend",this._handleMouseUp,!0);this._fire("transformend",{evt:e});var node=this.getNode();node&&node.fire("transformend",{evt:e})}};Transformer.prototype._fitNodeInto=function(newAttrs,evt){var boundBoxFunc=this.boundBoxFunc();if(boundBoxFunc){var oldAttrs=this._getNodeRect();newAttrs=boundBoxFunc.call(this,oldAttrs,newAttrs)}var node=this.getNode();void 0!==newAttrs.rotation&&this.getNode().rotation(newAttrs.rotation);
var pure=node.getClientRect({skipTransform:!0,skipShadow:!0,skipStroke:this.ignoreStroke()}),padding=this.padding();boundBoxFunc=(newAttrs.width-2*padding)/pure.width;oldAttrs=(newAttrs.height-2*padding)/pure.height;var rotation=Global_1.Konva.getAngle(node.rotation()),dx=pure.x*boundBoxFunc-padding-node.offsetX()*boundBoxFunc;node=pure.y*oldAttrs-padding-node.offsetY()*oldAttrs;this.getNode().setAttrs({scaleX:boundBoxFunc,scaleY:oldAttrs,x:newAttrs.x-(dx*Math.cos(rotation)+node*Math.sin(-rotation)),
y:newAttrs.y-(node*Math.cos(rotation)+dx*Math.sin(rotation))});this._fire("transform",{evt:evt});this.getNode()._fire("transform",{evt:evt});this.update();this.getLayer().batchDraw()};Transformer.prototype.forceUpdate=function(){this._resetTransformCache();this.update()};Transformer.prototype.update=function(){var _this=this,attrs=this._getNodeRect(),node$jscomp$0=this.getNode(),scale={x:1,y:1};node$jscomp$0&&node$jscomp$0.getParent()&&(scale=node$jscomp$0.getParent().getAbsoluteScale());node$jscomp$0=
{x:1/scale.x,y:1/scale.y};var width=attrs.width;attrs=attrs.height;var enabledAnchors=this.enabledAnchors(),resizeEnabled=this.resizeEnabled(),padding=this.padding(),anchorSize=this.anchorSize();this.find("._anchor").each(function(node){return node.setAttrs({width:anchorSize,height:anchorSize,offsetX:anchorSize/2,offsetY:anchorSize/2,stroke:_this.anchorStroke(),strokeWidth:_this.anchorStrokeWidth(),fill:_this.anchorFill(),cornerRadius:_this.anchorCornerRadius()})});this.findOne(".top-left").setAttrs({x:-padding,
y:-padding,scale:node$jscomp$0,visible:resizeEnabled&&0<=enabledAnchors.indexOf("top-left")});this.findOne(".top-center").setAttrs({x:width/2,y:-padding,scale:node$jscomp$0,visible:resizeEnabled&&0<=enabledAnchors.indexOf("top-center")});this.findOne(".top-right").setAttrs({x:width+padding,y:-padding,scale:node$jscomp$0,visible:resizeEnabled&&0<=enabledAnchors.indexOf("top-right")});this.findOne(".middle-left").setAttrs({x:-padding,y:attrs/2,scale:node$jscomp$0,visible:resizeEnabled&&0<=enabledAnchors.indexOf("middle-left")});
this.findOne(".middle-right").setAttrs({x:width+padding,y:attrs/2,scale:node$jscomp$0,visible:resizeEnabled&&0<=enabledAnchors.indexOf("middle-right")});this.findOne(".bottom-left").setAttrs({x:-padding,y:attrs+padding,scale:node$jscomp$0,visible:resizeEnabled&&0<=enabledAnchors.indexOf("bottom-left")});this.findOne(".bottom-center").setAttrs({x:width/2,y:attrs+padding,scale:node$jscomp$0,visible:resizeEnabled&&0<=enabledAnchors.indexOf("bottom-center")});this.findOne(".bottom-right").setAttrs({x:width+
padding,y:attrs+padding,scale:node$jscomp$0,visible:resizeEnabled&&0<=enabledAnchors.indexOf("bottom-right")});enabledAnchors=-this.rotateAnchorOffset()*Math.abs(node$jscomp$0.y);this.findOne(".rotater").setAttrs({x:width/2,y:enabledAnchors*Util_1.Util._sign(attrs),scale:node$jscomp$0,visible:this.rotateEnabled()});this.findOne(".back").setAttrs({width:width*scale.x,height:attrs*scale.y,scale:node$jscomp$0,visible:this.borderEnabled(),stroke:this.borderStroke(),strokeWidth:this.borderStrokeWidth(),
dash:this.borderDash()})};Transformer.prototype.isTransforming=function(){return this._transforming};Transformer.prototype.stopTransform=function(){if(this._transforming){this._removeEvents();var anchorNode=this.findOne("."+this._movingAnchorName);anchorNode&&anchorNode.stopDrag()}};Transformer.prototype.destroy=function(){this.getStage()&&this._cursorChange&&(this.getStage().content.style.cursor="");Group_1.Group.prototype.destroy.call(this);this.detach();this._removeEvents();return this};Transformer.prototype.toObject=
function(){return Node_1.Node.prototype.toObject.call(this)};return Transformer}(Group_1.Group);exports.Transformer=Transformer;Transformer.prototype.className="Transformer";require._registerNode(Transformer);global.Factory.addGetterSetter(Transformer,"enabledAnchors",ANCHORS_NAMES,function(val){val instanceof Array||Util_1.Util.warn("enabledAnchors value should be an array");val instanceof Array&&val.forEach(function(name){-1===ANCHORS_NAMES.indexOf(name)&&Util_1.Util.warn("Unknown anchor name: "+
name+". Available names are: "+ANCHORS_NAMES.join(", "))});return val||[]});global.Factory.addGetterSetter(Transformer,"resizeEnabled",!0);global.Factory.addGetterSetter(Transformer,"anchorSize",10,module.getNumberValidator());global.Factory.addGetterSetter(Transformer,"rotateEnabled",!0);global.Factory.addGetterSetter(Transformer,"rotationSnaps",[]);global.Factory.addGetterSetter(Transformer,"rotateAnchorOffset",50,module.getNumberValidator());global.Factory.addGetterSetter(Transformer,"borderEnabled",
!0);global.Factory.addGetterSetter(Transformer,"anchorStroke","rgb(0, 161, 255)");global.Factory.addGetterSetter(Transformer,"anchorStrokeWidth",1,module.getNumberValidator());global.Factory.addGetterSetter(Transformer,"anchorFill","white");global.Factory.addGetterSetter(Transformer,"anchorCornerRadius",0,module.getNumberValidator());global.Factory.addGetterSetter(Transformer,"borderStroke","rgb(0, 161, 255)");global.Factory.addGetterSetter(Transformer,"borderStrokeWidth",1,module.getNumberValidator());
global.Factory.addGetterSetter(Transformer,"borderDash");global.Factory.addGetterSetter(Transformer,"keepRatio",!0);global.Factory.addGetterSetter(Transformer,"centeredScaling",!1);global.Factory.addGetterSetter(Transformer,"ignoreStroke",!1);global.Factory.addGetterSetter(Transformer,"padding",0,module.getNumberValidator());global.Factory.addGetterSetter(Transformer,"node");global.Factory.addGetterSetter(Transformer,"boundBoxFunc");global.Factory.backCompat(Transformer,{lineEnabled:"borderEnabled",
rotateHandlerOffset:"rotateAnchorOffset",enabledHandlers:"enabledAnchors"});Util_1.Collection.mapMethods(Transformer)}
//# sourceMappingURL=module$node_modules$konva$lib$shapes$Transformer.js.map
