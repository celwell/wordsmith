shadow$provide.module$node_modules$konva$lib$Stage=function(global,require,module,exports){function addEvent(ctx,eventName){ctx.content.addEventListener(eventName,function(evt){ctx["_"+eventName](evt)},!1)}function checkNoClip(attrs){void 0===attrs&&(attrs={});(attrs.clipFunc||attrs.clipWidth||attrs.clipHeight)&&Util_1.Util.warn("Stage does not support clipping. Please use clip for Layers or Groups.");return attrs}var __extends=this&&this.__extends||function(){var extendStatics=function(d$jscomp$0,
b$jscomp$0){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return extendStatics(d$jscomp$0,b$jscomp$0)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b);d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Util_1=require("module$node_modules$konva$lib$Util");global=require("module$node_modules$konva$lib$Factory");
var Container_1=require("module$node_modules$konva$lib$Container"),Global_1=require("module$node_modules$konva$lib$Global"),Canvas_1=require("module$node_modules$konva$lib$Canvas"),DragAndDrop_1=require("module$node_modules$konva$lib$DragAndDrop");module=require("module$node_modules$konva$lib$Global");var PointerEvents=require("module$node_modules$konva$lib$PointerEvents"),EVENTS="mouseenter mousedown mousemove mouseup mouseout touchstart touchmove touchend mouseover wheel contextmenu pointerdown pointermove pointerup pointercancel lostpointercapture".split(" "),
eventsLength=EVENTS.length;exports.stages=[];require=function(_super){function Stage(config){var _this=_super.call(this,checkNoClip(config))||this;_this._pointerPositions=[];_this._changedPointerPositions=[];_this._buildDOM();_this._bindContentEvents();exports.stages.push(_this);_this.on("widthChange.konva heightChange.konva",_this._resizeDOM);_this.on("visibleChange.konva",_this._checkVisibility);_this.on("clipWidthChange.konva clipHeightChange.konva clipFuncChange.konva",function(){checkNoClip(_this.attrs)});
_this._checkVisibility();return _this}__extends(Stage,_super);Stage.prototype._validateAdd=function(child){var isLayer="Layer"===child.getType();child="FastLayer"===child.getType();isLayer||child||Util_1.Util.throw("You may only add layers to the stage.")};Stage.prototype._checkVisibility=function(){var style=this.visible()?"":"none";this.content.style.display=style};Stage.prototype.setContainer=function(container){if("string"===typeof container){if("."===container.charAt(0))container=container.slice(1),
container=document.getElementsByClassName(container)[0];else{var id="#"!==container.charAt(0)?container:container.slice(1);container=document.getElementById(id)}if(!container)throw"Can not find container in document with id "+id;}this._setAttr("container",container);this.content&&(this.content.parentElement&&this.content.parentElement.removeChild(this.content),container.appendChild(this.content));return this};Stage.prototype.shouldDrawHit=function(){return!0};Stage.prototype.clear=function(){var layers=
this.children,len=layers.length,n;for(n=0;n<len;n++)layers[n].clear();return this};Stage.prototype.clone=function(obj){obj||(obj={});obj.container=document.createElement("div");return Container_1.Container.prototype.clone.call(this,obj)};Stage.prototype.destroy=function(){_super.prototype.destroy.call(this);var content=this.content;content&&Util_1.Util._isInDocument(content)&&this.container().removeChild(content);content=exports.stages.indexOf(this);-1<content&&exports.stages.splice(content,1);return this};
Stage.prototype.getPointerPosition=function(){var pos=this._pointerPositions[0]||this._changedPointerPositions[0];return pos?{x:pos.x,y:pos.y}:(Util_1.Util.warn("Pointer position is missing and not registered by the stage. Looks like it is outside of the stage container. You can set it manually from event: stage.setPointersPositions(event);"),null)};Stage.prototype._getPointerById=function(id){return this._pointerPositions.find(function(p){return p.id===id})};Stage.prototype.getPointersPositions=
function(){return this._pointerPositions};Stage.prototype.getStage=function(){return this};Stage.prototype.getContent=function(){return this.content};Stage.prototype._toKonvaCanvas=function(config){config=config||{};var x=config.x||0,y=config.y||0,canvas=new Canvas_1.SceneCanvas({width:config.width||this.width(),height:config.height||this.height(),pixelRatio:config.pixelRatio||1}),_context=canvas.getContext()._context,layers=this.children;(x||y)&&_context.translate(-1*x,-1*y);layers.each(function(layer){layer.isVisible()&&
(layer=layer._toKonvaCanvas(config),_context.drawImage(layer._canvas,x,y,layer.getWidth()/layer.getPixelRatio(),layer.getHeight()/layer.getPixelRatio()))});return canvas};Stage.prototype.getIntersection=function(pos,selector){if(!pos)return null;var layers=this.children,n,shape;for(n=layers.length-1;0<=n;n--)if(shape=layers[n].getIntersection(pos,selector))return shape;return null};Stage.prototype._resizeDOM=function(){if(this.content){var width=this.width(),height=this.height(),layers=this.getChildren(),
len=layers.length,n;this.content.style.width=width+"px";this.content.style.height=height+"px";this.bufferCanvas.setSize(width,height);this.bufferHitCanvas.setSize(width,height);for(n=0;n<len;n++){var layer=layers[n];layer.setSize({width:width,height:height});layer.draw()}}};Stage.prototype.add=function(layer){if(1<arguments.length){for(var i=0;i<arguments.length;i++)this.add(arguments[i]);return this}_super.prototype.add.call(this,layer);i=this.children.length;5<i&&Util_1.Util.warn("The stage has "+
i+" layers. Recommended maximin number of layers is 3-5. Adding more layers into the stage may drop the performance. Rethink your tree structure, you can use Konva.Group.");layer._setCanvasSize(this.width(),this.height());layer.draw();Global_1.Konva.isBrowser&&this.content.appendChild(layer.canvas._canvas);return this};Stage.prototype.getParent=function(){return null};Stage.prototype.getLayer=function(){return null};Stage.prototype.hasPointerCapture=function(pointerId){return PointerEvents.hasPointerCapture(pointerId,
this)};Stage.prototype.setPointerCapture=function(pointerId){PointerEvents.setPointerCapture(pointerId,this)};Stage.prototype.releaseCapture=function(pointerId){PointerEvents.releaseCapture(pointerId,this)};Stage.prototype.getLayers=function(){return this.getChildren()};Stage.prototype._bindContentEvents=function(){if(Global_1.Konva.isBrowser)for(var n=0;n<eventsLength;n++)addEvent(this,EVENTS[n])};Stage.prototype._mouseenter=function(evt){this.setPointersPositions(evt);this._fire("mouseenter",{evt:evt,
target:this,currentTarget:this})};Stage.prototype._mouseover=function(evt){this.setPointersPositions(evt);this._fire("contentMouseover",{evt:evt});this._fire("mouseover",{evt:evt,target:this,currentTarget:this})};Stage.prototype._mouseout=function(evt){this.setPointersPositions(evt);var targetShape=this.targetShape,eventsEnabled=!DragAndDrop_1.DD.isDragging||Global_1.Konva.hitOnDragEnabled;targetShape&&eventsEnabled?(targetShape._fireAndBubble("mouseout",{evt:evt}),targetShape._fireAndBubble("mouseleave",
{evt:evt}),this.targetShape=null):eventsEnabled&&(this._fire("mouseleave",{evt:evt,target:this,currentTarget:this}),this._fire("mouseout",{evt:evt,target:this,currentTarget:this}));this.pointerPos=void 0;this._pointerPositions=[];this._fire("contentMouseout",{evt:evt})};Stage.prototype._mousemove=function(evt){if(Global_1.Konva.UA.ieMobile)return this._touchmove(evt);this.setPointersPositions(evt);var pointerId=Util_1.Util._getFirstPointerId(evt),shape,eventsEnabled=!DragAndDrop_1.DD.isDragging||
Global_1.Konva.hitOnDragEnabled;if(eventsEnabled){if((shape=this.getIntersection(this.getPointerPosition()))&&shape.isListening()){var differentTarget=!this.targetShape||this.targetShape!==shape;eventsEnabled&&differentTarget?(this.targetShape&&(this.targetShape._fireAndBubble("mouseout",{evt:evt,pointerId:pointerId},shape),this.targetShape._fireAndBubble("mouseleave",{evt:evt,pointerId:pointerId},shape)),shape._fireAndBubble("mouseover",{evt:evt,pointerId:pointerId},this.targetShape),shape._fireAndBubble("mouseenter",
{evt:evt,pointerId:pointerId},this.targetShape),shape._fireAndBubble("mousemove",{evt:evt,pointerId:pointerId}),this.targetShape=shape):shape._fireAndBubble("mousemove",{evt:evt,pointerId:pointerId})}else this.targetShape&&eventsEnabled&&(this.targetShape._fireAndBubble("mouseout",{evt:evt,pointerId:pointerId}),this.targetShape._fireAndBubble("mouseleave",{evt:evt,pointerId:pointerId}),this._fire("mouseover",{evt:evt,target:this,currentTarget:this,pointerId:pointerId}),this.targetShape=null),this._fire("mousemove",
{evt:evt,target:this,currentTarget:this,pointerId:pointerId});this._fire("contentMousemove",{evt:evt})}evt.cancelable&&evt.preventDefault()};Stage.prototype._mousedown=function(evt){if(Global_1.Konva.UA.ieMobile)return this._touchstart(evt);this.setPointersPositions(evt);var pointerId=Util_1.Util._getFirstPointerId(evt),shape=this.getIntersection(this.getPointerPosition());Global_1.Konva.listenClickTap=!0;shape&&shape.isListening()?(this.clickStartShape=shape,shape._fireAndBubble("mousedown",{evt:evt,
pointerId:pointerId})):this._fire("mousedown",{evt:evt,target:this,currentTarget:this,pointerId:pointerId});this._fire("contentMousedown",{evt:evt})};Stage.prototype._mouseup=function(evt){if(Global_1.Konva.UA.ieMobile)return this._touchend(evt);this.setPointersPositions(evt);var pointerId=Util_1.Util._getFirstPointerId(evt),shape=this.getIntersection(this.getPointerPosition()),clickStartShape=this.clickStartShape,clickEndShape=this.clickEndShape,fireDblClick=!1;Global_1.Konva.inDblClickWindow?(fireDblClick=
!0,clearTimeout(this.dblTimeout)):DragAndDrop_1.DD.justDragged?DragAndDrop_1.DD&&(DragAndDrop_1.DD.justDragged=!1):(Global_1.Konva.inDblClickWindow=!0,clearTimeout(this.dblTimeout));this.dblTimeout=setTimeout(function(){Global_1.Konva.inDblClickWindow=!1},Global_1.Konva.dblClickWindow);shape&&shape.isListening()?(this.clickEndShape=shape,shape._fireAndBubble("mouseup",{evt:evt,pointerId:pointerId}),Global_1.Konva.listenClickTap&&clickStartShape&&clickStartShape._id===shape._id&&(shape._fireAndBubble("click",
{evt:evt,pointerId:pointerId}),fireDblClick&&clickEndShape&&clickEndShape===shape&&shape._fireAndBubble("dblclick",{evt:evt,pointerId:pointerId}))):(this._fire("mouseup",{evt:evt,target:this,currentTarget:this,pointerId:pointerId}),Global_1.Konva.listenClickTap&&this._fire("click",{evt:evt,target:this,currentTarget:this,pointerId:pointerId}),fireDblClick&&this._fire("dblclick",{evt:evt,target:this,currentTarget:this,pointerId:pointerId}));this._fire("contentMouseup",{evt:evt});Global_1.Konva.listenClickTap&&
(this._fire("contentClick",{evt:evt}),fireDblClick&&this._fire("contentDblclick",{evt:evt}));Global_1.Konva.listenClickTap=!1;evt.cancelable&&evt.preventDefault()};Stage.prototype._contextmenu=function(evt){this.setPointersPositions(evt);var shape=this.getIntersection(this.getPointerPosition());shape&&shape.isListening()?shape._fireAndBubble("contextmenu",{evt:evt}):this._fire("contextmenu",{evt:evt,target:this,currentTarget:this});this._fire("contentContextmenu",{evt:evt})};Stage.prototype._touchstart=
function(evt){var _this=this;this.setPointersPositions(evt);var triggeredOnShape=!1;this._changedPointerPositions.forEach(function(pos){var shape=_this.getIntersection(pos);Global_1.Konva.listenClickTap=!0;shape&&shape.isListening()&&(Global_1.Konva.captureTouchEventsEnabled&&shape.setPointerCapture(pos.id),_this.tapStartShape=shape,shape._fireAndBubble("touchstart",{evt:evt,pointerId:pos.id},_this),triggeredOnShape=!0,shape.isListening()&&shape.preventDefault()&&evt.cancelable&&evt.preventDefault())});
triggeredOnShape||this._fire("touchstart",{evt:evt,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id});this._fire("contentTouchstart",{evt:evt})};Stage.prototype._touchmove=function(evt){var _this=this;this.setPointersPositions(evt);if(!DragAndDrop_1.DD.isDragging||Global_1.Konva.hitOnDragEnabled){var triggeredOnShape=!1,processedShapesIds={};this._changedPointerPositions.forEach(function(pos){var shape=PointerEvents.getCapturedShape(pos.id)||_this.getIntersection(pos);
shape&&shape.isListening()&&!processedShapesIds[shape._id]&&(processedShapesIds[shape._id]=!0,shape._fireAndBubble("touchmove",{evt:evt,pointerId:pos.id}),triggeredOnShape=!0,shape.isListening()&&shape.preventDefault()&&evt.cancelable&&evt.preventDefault())});triggeredOnShape||this._fire("touchmove",{evt:evt,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id});this._fire("contentTouchmove",{evt:evt})}DragAndDrop_1.DD.isDragging&&DragAndDrop_1.DD.node.preventDefault()&&evt.cancelable&&
evt.preventDefault()};Stage.prototype._touchend=function(evt){var _this=this;this.setPointersPositions(evt);var clickEndShape=this.clickEndShape,fireDblClick=!1;Global_1.Konva.inDblClickWindow?(fireDblClick=!0,clearTimeout(this.dblTimeout)):DragAndDrop_1.DD.justDragged||(Global_1.Konva.inDblClickWindow=!0,clearTimeout(this.dblTimeout));this.dblTimeout=setTimeout(function(){Global_1.Konva.inDblClickWindow=!1},Global_1.Konva.dblClickWindow);var triggeredOnShape=!1,processedShapesIds={},tapTriggered=
!1,dblTapTriggered=!1;this._changedPointerPositions.forEach(function(pos){var shape=PointerEvents.getCapturedShape(pos.id)||_this.getIntersection(pos);shape&&shape.releaseCapture(pos.id);shape&&shape.isListening()&&!processedShapesIds[shape._id]&&(processedShapesIds[shape._id]=!0,_this.clickEndShape=shape,shape._fireAndBubble("touchend",{evt:evt,pointerId:pos.id}),triggeredOnShape=!0,Global_1.Konva.listenClickTap&&shape===_this.tapStartShape&&(tapTriggered=!0,shape._fireAndBubble("tap",{evt:evt,pointerId:pos.id}),
fireDblClick&&clickEndShape&&clickEndShape===shape&&(dblTapTriggered=!0,shape._fireAndBubble("dbltap",{evt:evt,pointerId:pos.id}))),shape.isListening()&&shape.preventDefault()&&evt.cancelable&&evt.preventDefault())});triggeredOnShape||this._fire("touchend",{evt:evt,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id});Global_1.Konva.listenClickTap&&!tapTriggered&&this._fire("tap",{evt:evt,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id});fireDblClick&&
!dblTapTriggered&&this._fire("dbltap",{evt:evt,target:this,currentTarget:this,pointerId:this._changedPointerPositions[0].id});this._fire("contentTouchend",{evt:evt});Global_1.Konva.listenClickTap&&(this._fire("contentTap",{evt:evt}),fireDblClick&&this._fire("contentDbltap",{evt:evt}));Global_1.Konva.listenClickTap=!1};Stage.prototype._wheel=function(evt){this.setPointersPositions(evt);var shape=this.getIntersection(this.getPointerPosition());shape&&shape.isListening()?shape._fireAndBubble("wheel",
{evt:evt}):this._fire("wheel",{evt:evt,target:this,currentTarget:this});this._fire("contentWheel",{evt:evt})};Stage.prototype._pointerdown=function(evt){if(Global_1.Konva._pointerEventsEnabled){this.setPointersPositions(evt);var shape=PointerEvents.getCapturedShape(evt.pointerId)||this.getIntersection(this.getPointerPosition());shape&&shape._fireAndBubble("pointerdown",PointerEvents.createEvent(evt))}};Stage.prototype._pointermove=function(evt){if(Global_1.Konva._pointerEventsEnabled){this.setPointersPositions(evt);
var shape=PointerEvents.getCapturedShape(evt.pointerId)||this.getIntersection(this.getPointerPosition());shape&&shape._fireAndBubble("pointermove",PointerEvents.createEvent(evt))}};Stage.prototype._pointerup=function(evt){if(Global_1.Konva._pointerEventsEnabled){this.setPointersPositions(evt);var shape=PointerEvents.getCapturedShape(evt.pointerId)||this.getIntersection(this.getPointerPosition());shape&&shape._fireAndBubble("pointerup",PointerEvents.createEvent(evt));PointerEvents.releaseCapture(evt.pointerId)}};
Stage.prototype._pointercancel=function(evt){if(Global_1.Konva._pointerEventsEnabled){this.setPointersPositions(evt);var shape=PointerEvents.getCapturedShape(evt.pointerId)||this.getIntersection(this.getPointerPosition());shape&&shape._fireAndBubble("pointerup",PointerEvents.createEvent(evt));PointerEvents.releaseCapture(evt.pointerId)}};Stage.prototype._lostpointercapture=function(evt){PointerEvents.releaseCapture(evt.pointerId)};Stage.prototype.setPointersPositions=function(evt){var _this=this,
contentPosition=this._getContentPosition(),x=null,y=null;evt=evt?evt:window.event;void 0!==evt.touches?(this._pointerPositions=[],this._changedPointerPositions=[],Util_1.Collection.prototype.each.call(evt.touches,function(touch){_this._pointerPositions.push({id:touch.identifier,x:touch.clientX-contentPosition.left,y:touch.clientY-contentPosition.top})}),Util_1.Collection.prototype.each.call(evt.changedTouches||evt.touches,function(touch){_this._changedPointerPositions.push({id:touch.identifier,x:touch.clientX-
contentPosition.left,y:touch.clientY-contentPosition.top})}),0<evt.touches.length&&(evt=evt.touches[0],x=evt.clientX-contentPosition.left,y=evt.clientY-contentPosition.top)):(x=evt.clientX-contentPosition.left,y=evt.clientY-contentPosition.top,this.pointerPos={x:x,y:y},this._pointerPositions=[{x:x,y:y,id:Util_1.Util._getFirstPointerId(evt)}],this._changedPointerPositions=[{x:x,y:y,id:Util_1.Util._getFirstPointerId(evt)}])};Stage.prototype._setPointerPosition=function(evt){Util_1.Util.warn('Method _setPointerPosition is deprecated. Use "stage.setPointersPositions(event)" instead.');
this.setPointersPositions(evt)};Stage.prototype._getContentPosition=function(){var rect=this.content.getBoundingClientRect?this.content.getBoundingClientRect():{top:0,left:0};return{top:rect.top,left:rect.left}};Stage.prototype._buildDOM=function(){this.bufferCanvas=new Canvas_1.SceneCanvas;this.bufferHitCanvas=new Canvas_1.HitCanvas({pixelRatio:1});if(Global_1.Konva.isBrowser){var container=this.container();if(!container)throw"Stage has no container. A container is required.";container.innerHTML=
"";this.content=document.createElement("div");this.content.style.position="relative";this.content.style.userSelect="none";this.content.className="konvajs-content";this.content.setAttribute("role","presentation");container.appendChild(this.content);this._resizeDOM()}};Stage.prototype.cache=function(){Util_1.Util.warn("Cache function is not allowed for stage. You may use cache only for layers, groups and shapes.");return this};Stage.prototype.clearCache=function(){return this};Stage.prototype.batchDraw=
function(){this.children.each(function(layer){layer.batchDraw()});return this};return Stage}(Container_1.Container);exports.Stage=require;require.prototype.nodeType="Stage";module._registerNode(require);global.Factory.addGetterSetter(require,"container")}
//# sourceMappingURL=module$node_modules$konva$lib$Stage.js.map
